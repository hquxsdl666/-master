# 中医脉象诊断软件系统设计文档

## 一、项目概述

### 1.1 项目背景

本项目旨在开发一款基于华为WATCH GT4智能手表的中医脉象诊断系统，通过手表内置的高性能PPG传感器采集脉搏波数据，结合中医脉诊理论和人工智能算法，实现数字化脉象诊断，并通过安卓客户端进行数据可视化展示和中医方剂指导。

### 1.2 产品定位

- **产品名称**：脉诊通（PulseDiag）
- **目标设备**：华为WATCH GT4（466×466分辨率，HarmonyOS）
- **配套应用**：Android客户端（Android 8.0+）
- **核心功能**：脉象采集 → 智能分析 → 报告生成 → 方剂推荐

### 1.3 核心特性

| 特性 | 描述 |
|------|------|
| 28种脉象识别 | 支持中医传统28种脉象的智能识别 |
| 三部九候检测 | 模拟寸关尺三部位、浮中沉三指法的脉象采集 |
| 实时数据分析 | 基于PPG信号的实时脉象特征提取和分析 |
| 个性化方剂推荐 | 根据脉象结果智能推荐中医方剂 |
| 历史记录追踪 | 长期脉象数据存储和趋势分析 |
| 中西医双模 | 融合中医脉诊与西医心血管指标分析 |

---

## 二、系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           中医脉象诊断系统架构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐         蓝牙BLE 5.0          ┌─────────────────────┐   │
│  │   华为WATCH     │ ◄──────────────────────────► │   Android客户端      │   │
│  │   GT4 手表端     │                              │   (数据可视化)        │   │
│  │                 │                              │                     │   │
│  │ • PPG传感器采集  │                              │ • 脉象报告展示        │   │
│  │ • 信号预处理     │                              │ • 历史记录管理        │   │
│  │ • 特征提取       │                              │ • 方剂推荐系统        │   │
│  │ • 本地缓存       │                              │ • 数据同步管理        │   │
│  └─────────────────┘                              └─────────────────────┘   │
│           │                                                │                │
│           │                                        ┌───────┴────────┐       │
│           │                                        │                │       │
│           ▼                                        ▼                ▼       │
│  ┌─────────────────┐                      ┌─────────────────┐  ┌──────────┐ │
│  │  边缘AI推理引擎  │                      │   云端AI服务     │  │ 中医知识库 │ │
│  │                 │                      │                 │  │          │ │
│  │ • 脉象分类模型   │                      │ • 深度学习模型   │  │ • 方剂库  │ │
│  │ • 信号质量评估   │                      │ • 大数据分析    │  │ • 药材库  │ │
│  │ • 轻量级推理     │                      │ • 模型训练更新  │  │ • 医案库  │ │
│  └─────────────────┘                      └─────────────────┘  └──────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

#### 手表端（华为WATCH GT4）

| 层级 | 技术/框架 | 说明 |
|------|----------|------|
| 操作系统 | HarmonyOS 4.0+ | 华为自研分布式操作系统 |
| 开发语言 | ArkTS / JS | 鸿蒙原生开发语言 |
| UI框架 | ArkUI Lite | 轻量级UI框架 |
| 传感器API | Sensor Kit | 心率/PPG传感器访问 |
| 数据存储 | Distributed Data | 分布式数据管理 |
| 通信协议 | Wear Engine | 手表与手机通信服务 |

#### Android客户端

| 层级 | 技术/框架 | 说明 |
|------|----------|------|
| 开发语言 | Kotlin | Android官方推荐语言 |
| UI框架 | Jetpack Compose | 现代声明式UI框架 |
| 架构模式 | MVVM | 模型-视图-视图模型 |
| 本地存储 | Room + DataStore | 数据库和偏好存储 |
| 网络通信 | Retrofit + OkHttp | RESTful API通信 |
| 图表展示 | MPAndroidChart | 数据可视化图表 |
| 蓝牙通信 | Bluetooth LE | 低功耗蓝牙通信 |

#### 云端服务

| 层级 | 技术/框架 | 说明 |
|------|----------|------|
| 后端框架 | Spring Boot | Java微服务框架 |
| 数据库 | PostgreSQL + Redis | 关系型数据库和缓存 |
| AI推理 | TensorFlow Serving | 模型服务部署 |
| 消息队列 | RabbitMQ | 异步任务处理 |
| 文件存储 | MinIO | 对象存储服务 |

---

## 三、华为WATCH GT4手表端设计

### 3.1 硬件能力分析

华为WATCH GT4核心传感器规格：

| 传感器 | 规格参数 | 应用场景 |
|--------|----------|----------|
| PPG传感器 | 绿光525nm±30nm，红外940±45nm<br>LED驱动电流5~200mA，SNR≥80dB | 脉搏波采集、心率监测 |
| 加速度计 | 量程±8g，采样频率≥100Hz | 运动检测、姿态识别 |
| 陀螺仪 | 三轴陀螺仪 | 手腕姿态检测 |
| 气压计 | 高精度气压传感器 | 海拔检测 |

### 3.2 手表端功能模块

```
┌─────────────────────────────────────────────────────────┐
│                   手表端功能架构                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │
│  │   脉象采集   │  │   信号处理   │  │    AI推理引擎    │ │
│  │    模块     │  │    模块     │  │                 │ │
│  ├─────────────┤  ├─────────────┤  ├─────────────────┤ │
│  │ • PPG采集   │  │ • 滤波降噪   │  │ • 脉象分类模型   │ │
│  │ • 质量检测  │  │ • 基线校正   │  │ • 特征向量计算   │ │
│  │ • 数据缓存  │  │ • 峰值检测   │  │ • 置信度评估    │ │
│  │ • 运动补偿  │  │ • 周期分割   │  │ • 边缘推理优化  │ │
│  └─────────────┘  └─────────────┘  └─────────────────┘ │
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │
│  │   用户界面   │  │   数据管理   │  │    设备通信     │ │
│  │    模块     │  │    模块     │  │                 │ │
│  ├─────────────┤  ├─────────────┤  ├─────────────────┤ │
│  │ • 采集引导   │  │ • 本地缓存   │  │ • 蓝牙连接管理  │ │
│  │ • 实时反馈   │  │ • 数据压缩   │  │ • 数据同步     │ │
│  │ • 结果显示   │  │ • 历史记录   │  │ • 命令接收     │ │
│  │ • 语音播报   │  │ • 断点续传   │  │ • 状态上报     │ │
│  └─────────────┘  └─────────────┘  └─────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.3 手表端界面设计

#### 3.3.1 主界面

```
┌─────────────────────────┐
│      脉诊通 (PulseDiag)  │
│                         │
│    ┌─────────────┐      │
│    │             │      │
│    │   脉象图标   │      │
│    │   (动画)    │      │
│    │             │      │
│    └─────────────┘      │
│                         │
│    [开始脉诊]           │
│                         │
│    上次检测: 2小时前     │
│    脉象: 平和脉 ✓       │
│                         │
│  [记录]  [设置]  [帮助]  │
└─────────────────────────┘
```

#### 3.3.2 脉诊采集界面

```
┌─────────────────────────┐
│      脉诊采集中...       │
│                         │
│    ┌─────────────┐      │
│    │  波形动画   │      │
│    │  实时显示   │      │
│    └─────────────┘      │
│                         │
│    进度: ████████░░ 80% │
│                         │
│    信号质量: 良好 ✓     │
│    剩余时间: 15秒       │
│                         │
│    请保持手腕平稳...     │
│                         │
│      [取消采集]         │
└─────────────────────────┘
```

#### 3.3.3 脉诊结果界面

```
┌─────────────────────────┐
│       脉诊结果          │
│                         │
│    ┌─────────────┐      │
│    │   脉象图示   │      │
│    │   弦脉      │      │
│    └─────────────┘      │
│                         │
│    主要脉象: 弦脉        │
│    辅助脉象: 细脉        │
│                         │
│    辨证: 肝郁气滞        │
│    置信度: 87%          │
│                         │
│    [查看详情]           │
│    [同步到手机]         │
│                         │
└─────────────────────────┘
```

### 3.4 脉象采集流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  开始采集  │───►│  传感器   │───►│  信号质量  │───►│  数据预   │
│          │    │  初始化   │    │  检测    │    │  处理    │
└──────────┘    └──────────┘    └────┬─────┘    └────┬─────┘
                                      │               │
                                      ▼               ▼
                               ┌──────────┐    ┌──────────┐
                               │ 信号质量  │    │  特征提取  │
                               │ 不合格   │◄───│          │
                               │ 重新采集  │    │          │
                               └────┬─────┘    └────┬─────┘
                                    │               │
                                    ▼               ▼
                               ┌──────────┐    ┌──────────┐
                               │  采集完成  │◄───│  AI推理   │
                               │  结果显示  │    │  脉象分类  │
                               └──────────┘    └──────────┘
```

### 3.5 信号处理算法

#### 3.5.1 PPG信号预处理流程

```python
# PPG信号预处理流程

# 1. 原始信号采集 (采样率: 100Hz)
raw_ppg = sensor.read_ppg(duration=60s, sample_rate=100Hz)

# 2. 带通滤波 (0.5Hz - 8Hz，去除基线漂移和高频噪声)
filtered_ppg = bandpass_filter(raw_ppg, low=0.5Hz, high=8Hz)

# 3. 陷波滤波 (去除50Hz工频干扰)
notched_ppg = notch_filter(filtered_ppg, freq=50Hz)

# 4. 平滑处理 (移动平均滤波)
smooth_ppg = moving_average(notched_ppg, window=5)

# 5. 归一化处理
normalized_ppg = normalize(smooth_ppg, method='z-score')

# 6. 峰值检测和周期分割
peaks = detect_peaks(normalized_ppg, min_distance=300ms)
cycles = segment_cycles(normalized_ppg, peaks)
```

#### 3.5.2 特征提取参数

| 特征类别 | 特征名称 | 计算方法 | 中医对应 |
|----------|----------|----------|----------|
| 时域特征 | 脉率 (HR) | 60 / 平均RR间期 | 迟数脉判断 |
| | 脉率变异性 (PRV) | RR间期标准差 | 节律整齐度 |
| | 收缩期幅度 (SA) | 峰值幅度 | 脉力强弱 |
| | 舒张期幅度 (DA) | 谷值幅度 | 脉道充盈度 |
| | 脉宽 (PW) | 半峰宽 | 脉体宽窄 |
| 频域特征 | 主频率 (MF) | FFT峰值频率 | 脉象基调 |
| | 高频功率 (HF) | 0.15-0.4Hz功率 | 副交感神经 |
| | 低频功率 (LF) | 0.04-0.15Hz功率 | 交感神经 |
| 形态特征 | 上升时间 (RT) | 起点到峰值时间 | 脉势急缓 |
| | 下降时间 (FT) | 峰值到谷值时间 | 脉势衰减 |
| | 重搏切迹 (DN) | 降支切迹深度 | 血管弹性 |
| | 波形面积 (WA) | 单周期积分 | 气血盛衰 |

---

## 四、Android客户端设计

### 4.1 客户端架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Android客户端架构                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      表现层 (UI Layer)                   │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ 首页模块  │ │ 脉诊模块  │ │ 记录模块  │ │ 我的模块  │   │   │
│  │  │          │ │          │ │          │ │          │   │   │
│  │  │• 数据概览 │ │• 实时采集 │ │• 历史列表 │ │• 个人中心 │   │   │
│  │  │• 健康建议 │ │• 报告展示 │ │• 趋势分析 │ │• 设备管理 │   │   │
│  │  │• 快捷入口 │ │• 方剂推荐 │ │• 对比分析 │ │• 设置    │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      业务逻辑层 (Domain Layer)           │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ 脉象服务  │ │ 报告服务  │ │ 方剂服务  │ │ 同步服务  │   │   │
│  │  │          │ │          │ │          │ │          │   │   │
│  │  │• 脉象分析 │ │• 报告生成 │ │• 方剂匹配 │ │• 数据同步 │   │   │
│  │  │• 数据解析 │ │• 图表生成 │ │• 禁忌检查 │ │• 冲突处理 │   │   │
│  │  │• 质量评估 │ │• PDF导出  │ │• 剂量计算 │ │• 离线支持 │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      数据层 (Data Layer)                 │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ 本地数据库 │ │ 远程API  │ │ 蓝牙通信  │ │ 文件存储  │   │   │
│  │  │          │ │          │ │          │ │          │   │   │
│  │  │• Room DB │ │• REST API│ │• BLE GATT│ │• 报告文件 │   │   │
│  │  │• 脉象记录 │ │• 云服务  │ │• 数据接收 │ │• 缓存管理 │   │   │
│  │  │• 用户配置 │ │• AI推理  │ │• 命令发送 │ │• 备份恢复 │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 主要界面设计

#### 4.2.1 首页

```
┌─────────────────────────────────┐
│  脉诊通                [通知]   │
│                                 │
│  ┌─────────────────────────┐   │
│  │    今日脉象健康指数      │   │
│  │                         │   │
│  │      ┌─────────┐        │   │
│  │      │   85    │        │   │
│  │      │   分    │        │   │
│  │      └─────────┘        │   │
│  │                         │   │
│  │   脉象: 平和偏弦        │   │
│  │   建议: 注意情绪调节     │   │
│  └─────────────────────────┘   │
│                                 │
│  快捷功能:                      │
│  ┌────────┐ ┌────────┐ ┌────────┐
│  │ 开始脉诊 │ │ 查看报告 │ │ 方剂查询 │
│  │  [图标]  │ │  [图标]  │ │  [图标]  │
│  └────────┘ └────────┘ └────────┘
│                                 │
│  最近记录:                      │
│  ┌─────────────────────────┐   │
│  │ 2024-01-15 09:30  弦脉  │   │
│  │ 2024-01-14 21:00  平和脉│   │
│  │ 2024-01-13 08:15  滑脉  │   │
│  └─────────────────────────┘   │
│                                 │
│  [首页]  [脉诊]  [记录]  [我的] │
└─────────────────────────────────┘
```

#### 4.2.2 脉诊报告详情页

```
┌─────────────────────────────────┐
│  < 返回        脉诊报告          │
│                                 │
│  检测时间: 2024-01-15 09:30     │
│  检测设备: 华为WATCH GT4        │
│                                 │
│  ┌─────────────────────────┐   │
│  │      脉象分析结果        │   │
│  │                         │   │
│  │    主要脉象: 弦脉        │   │
│  │    辅助脉象: 细脉        │   │
│  │    置信度: 87%          │   │
│  │                         │   │
│  │  [脉象波形图]            │   │
│  └─────────────────────────┘   │
│                                 │
│  脉象特征:                      │
│  ├─ 脉位: 中取                │
│  ├─ 脉率: 72次/分 (正常)      │
│  ├─ 脉力: 中等                │
│  ├─ 脉形: 端直而长            │
│  └─ 脉势: 来盛去衰            │
│                                 │
│  辨证分析:                      │
│  ┌─────────────────────────┐   │
│  │ 证型: 肝郁气滞证          │   │
│  │                         │   │
│  │ 分析: 弦脉主肝胆病，细脉   │   │
│  │ 提示气血不足。结合脉象     │   │
│  │ 特征，辨证为肝郁气滞。     │   │
│  └─────────────────────────┘   │
│                                 │
│  [查看推荐方剂]  [分享报告]     │
│                                 │
└─────────────────────────────────┘
```

#### 4.2.3 方剂推荐页

```
┌─────────────────────────────────┐
│  < 返回        方剂推荐          │
│                                 │
│  根据您的脉象: 弦脉 + 细脉       │
│  辨证: 肝郁气滞证               │
│                                 │
│  ┌─────────────────────────┐   │
│  │     推荐方剂: 柴胡疏肝散   │   │
│  │                         │   │
│  │  组成:                  │   │
│  │  • 柴胡 6g             │   │
│  │  • 香附 9g             │   │
│  │  • 川芎 9g             │   │
│  │  • 陈皮 9g             │   │
│  │  • 枳壳 9g             │   │
│  │  • 白芍 9g             │   │
│  │  • 甘草 3g             │   │
│  │                         │   │
│  │  用法: 水煎服，每日1剂    │   │
│  │  疗程: 7天为1疗程        │   │
│  └─────────────────────────┘   │
│                                 │
│  功效: 疏肝理气，活血止痛        │
│                                 │
│  主治:                          │
│  肝气郁结所致的胁肋疼痛，胸闷   │
│  喜太息，情志抑郁易怒等。       │
│                                 │
│  注意事项:                      │
│  ⚠ 孕妇慎用                   │
│  ⚠ 服药期间忌辛辣油腻         │
│                                 │
│  [保存方剂]  [咨询医师]  [修改] │
│                                 │
└─────────────────────────────────┘
```

#### 4.2.4 历史记录趋势页

```
┌─────────────────────────────────┐
│  < 返回        脉象趋势          │
│                                 │
│  时间范围: [近7天 ▼]            │
│                                 │
│  ┌─────────────────────────┐   │
│  │                         │   │
│  │   [脉象变化趋势图]       │   │
│  │                         │   │
│  │   弦脉 ────────         │   │
│  │   滑脉    ──            │   │
│  │   平和脉      ─────     │   │
│  │                         │   │
│  └─────────────────────────┘   │
│                                 │
│  脉率趋势:                      │
│  ┌─────────────────────────┐   │
│  │   [脉率变化曲线图]       │   │
│  │   平均: 72次/分          │   │
│  │   范围: 68-78次/分       │   │
│  └─────────────────────────┘   │
│                                 │
│  健康建议:                      │
│  ┌─────────────────────────┐   │
│  │ 近7天脉象以弦脉为主，     │   │
│  │ 建议注意情绪调节，避免    │   │
│  │ 过度劳累，可适当进行      │   │
│  │ 舒缓运动如太极、瑜伽。    │   │
│  └─────────────────────────┘   │
│                                 │
└─────────────────────────────────┘
```

### 4.3 数据可视化设计

#### 4.3.1 脉象雷达图

展示多维度脉象特征：

```
          脉力
           ▲
          /|\
         / | \
        /  |  \
   脉位 ───┼─── 脉率
        \  |  /
         \ | /
          \|/
           ▼
         脉形
```

维度：脉位(浮沉)、脉率(迟数)、脉力(虚实)、脉形(洪细)、脉势(滑涩)

#### 4.3.2 脉波波形图

实时显示PPG波形和特征点标记：

```
幅度 │    ╱╲      ╱╲      ╱╲
    │   ╱  ╲    ╱  ╲    ╱  ╲
    │  ╱    ╲  ╱ ●╲  ╱    ╲
    │ ╱      ╲╱   ╲╱      ╲
    │╱  ●                  ●
    └──────────────────────────► 时间
      S  DN  D           S  DN  D
      
      S = 收缩峰
      DN = 重搏切迹
      D = 舒张峰
```

---

## 五、中医脉象分析算法

### 5.1 28种脉象分类体系

```
中医28种脉象分类
│
├── 浮脉类 (脉位浅)
│   ├── 浮脉 - 轻按即得，主表证
│   ├── 洪脉 - 浮大有力，主热盛
│   ├── 濡脉 - 浮细无力，主虚湿
│   ├── 散脉 - 浮散无根，主元气离散
│   ├── 芤脉 - 浮大中空，主失血
│   └── 革脉 - 浮而搏指，主亡血失精
│
├── 沉脉类 (脉位深)
│   ├── 沉脉 - 重按始得，主里证
│   ├── 伏脉 - 推筋着骨，主邪闭
│   ├── 弱脉 - 沉细无力，主气血虚
│   └── 牢脉 - 沉实大弦，主阴寒内积
│
├── 迟脉类 (脉率慢 <60次/分)
│   ├── 迟脉 - 一息不足四至，主寒证
│   ├── 缓脉 - 一息四至，主湿/脾虚
│   ├── 涩脉 - 艰涩不畅，主气滞血瘀
│   └── 结脉 - 迟而时止，主阴盛气结
│
├── 数脉类 (脉率快 >90次/分)
│   ├── 数脉 - 一息五至以上，主热证
│   ├── 疾脉 - 一息七至以上，主阳极阴竭
│   ├── 促脉 - 数而时止，主阳热亢盛
│   └── 动脉 - 短滑数，主疼痛惊恐
│
├── 虚脉类 (脉力弱)
│   ├── 虚脉 - 举按无力，主气血虚
│   ├── 微脉 - 极细极软，主阳气衰
│   ├── 细脉 - 脉细如线，主气血虚
│   ├── 代脉 - 止有定数，主脏气衰
│   └── 短脉 - 不及本位，主气损
│
└── 实脉类 (脉力强)
    ├── 实脉 - 举按有力，主实证
    ├── 滑脉 - 往来流利，主痰食/妊娠
    ├── 紧脉 - 绷急有力，主寒痛
    ├── 长脉 - 超过本位，主阳证
    ├── 弦脉 - 端直如弦，主肝胆病
    └── 大脉 - 脉体宽大，主病进
```

### 5.2 脉象识别算法模型

#### 5.2.1 特征向量定义

```python
# 脉象特征向量 (共28维)
pulse_feature_vector = {
    # 脉位特征 (3维)
    'pulse_position': {
        'floating_score': 0.0,      # 浮脉得分 (0-1)
        'normal_depth_score': 0.0,  # 中脉得分 (0-1)
        'deep_score': 0.0,          # 沉脉得分 (0-1)
    },
    
    # 脉率特征 (4维)
    'pulse_rate': {
        'rate_value': 72,           # 脉率值 (次/分)
        'rate_category': 'normal',  # 类别: slow/normal/fast/rapid
        'rhythm_regularity': 0.95,  # 节律规整度 (0-1)
        'intermittent': False,      # 是否间歇
    },
    
    # 脉力特征 (3维)
    'pulse_force': {
        'force_score': 0.5,         # 脉力得分 (0-1)
        'systolic_amplitude': 1.0,  # 收缩期幅度
        'diastolic_amplitude': 0.3, # 舒张期幅度
    },
    
    # 脉形特征 (6维)
    'pulse_shape': {
        'width_score': 0.5,         # 脉宽得分 (0-1)
        'length_score': 0.5,        # 脉长得分 (0-1)
        'smoothness': 0.5,          # 光滑度 (0-1)
        'tautness': 0.5,            # 紧张度 (0-1)
        'fullness': 0.5,            # 充盈度 (0-1)
        'hollowness': 0.0,          # 中空度 (0-1)
    },
    
    # 脉势特征 (4维)
    'pulse_momentum': {
        'rising_slope': 0.5,        # 上升斜率
        'falling_slope': 0.5,       # 下降斜率
        'dicrotic_notch': 0.5,      # 重搏切迹
        'wave_area': 0.5,           # 波形面积
    },
    
    # 频域特征 (8维)
    'frequency_domain': {
        'dominant_freq': 1.2,       # 主频率 (Hz)
        'lf_power': 0.5,            # 低频功率
        'hf_power': 0.3,            # 高频功率
        'lf_hf_ratio': 1.67,        # 低高频比
        'spectral_entropy': 0.8,    # 谱熵
        # ... 其他频域特征
    }
}
```

#### 5.2.2 机器学习模型架构

```
┌─────────────────────────────────────────────────────────────┐
│                    脉象识别模型架构                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  输入层: PPG信号序列 (100Hz × 60s = 6000点)                  │
│                    │                                        │
│                    ▼                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              特征提取层 (Feature Extraction)          │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │ 时域特征  │  │ 频域特征  │  │ 形态特征  │          │   │
│  │  │ 提取模块  │  │ 提取模块  │  │ 提取模块  │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └─────────────────────────────────────────────────────┘   │
│                    │                                        │
│                    ▼                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              特征融合层 (Feature Fusion)              │   │
│  │         Concatenate + Dense (128 units)              │   │
│  └─────────────────────────────────────────────────────┘   │
│                    │                                        │
│                    ▼                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              分类层 (Classification)                  │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │  全连接层 (256) → ReLU → Dropout(0.3)       │   │   │
│  │  │  全连接层 (128) → ReLU → Dropout(0.3)       │   │   │
│  │  │  全连接层 (64)  → ReLU                      │   │   │
│  │  │  输出层 (28)   → Softmax                    │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                    │                                        │
│                    ▼                                        │
│  输出层: 28种脉象概率分布 + 置信度                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 5.2.3 脉象决策规则

```python
# 脉象决策规则库

PULSE_DECISION_RULES = {
    # 浮脉类
    'floating': {
        'condition': 'pulse_position.floating_score > 0.7',
        'subtypes': {
            '洪脉': 'force_score > 0.8 and width_score > 0.7',
            '濡脉': 'force_score < 0.3 and width_score < 0.4',
            '散脉': 'rhythm_regularity < 0.5',
            '芤脉': 'hollowness > 0.6',
            '革脉': 'tautness > 0.7 and hollowness > 0.4',
        }
    },
    
    # 沉脉类
    'deep': {
        'condition': 'pulse_position.deep_score > 0.7',
        'subtypes': {
            '伏脉': 'deep_score > 0.9',
            '弱脉': 'force_score < 0.3 and width_score < 0.4',
            '牢脉': 'force_score > 0.8 and tautness > 0.7',
        }
    },
    
    # 迟脉类
    'slow': {
        'condition': 'pulse_rate.rate_value < 60',
        'subtypes': {
            '缓脉': '60 <= pulse_rate.rate_value <= 70 and rhythm_regularity > 0.9',
            '涩脉': 'smoothness < 0.3',
            '结脉': 'intermittent == True and pulse_rate.rate_value < 60',
        }
    },
    
    # 数脉类
    'rapid': {
        'condition': 'pulse_rate.rate_value > 90',
        'subtypes': {
            '疾脉': 'pulse_rate.rate_value > 120',
            '促脉': 'intermittent == True and pulse_rate.rate_value > 90',
            '动脉': 'length_score < 0.3 and smoothness > 0.7',
        }
    },
    
    # 虚脉类
    'weak': {
        'condition': 'pulse_force.force_score < 0.3',
        'subtypes': {
            '微脉': 'width_score < 0.2 and force_score < 0.2',
            '细脉': 'width_score < 0.3',
            '代脉': 'intermittent == True and regular_interval == True',
            '短脉': 'length_score < 0.3',
        }
    },
    
    # 实脉类
    'strong': {
        'condition': 'pulse_force.force_score > 0.7',
        'subtypes': {
            '滑脉': 'smoothness > 0.8',
            '紧脉': 'tautness > 0.8',
            '长脉': 'length_score > 0.8',
            '弦脉': 'tautness > 0.7 and rising_slope > 0.7',
            '大脉': 'width_score > 0.7 and force_score > 0.7',
        }
    }
}
```

### 5.3 辨证论治模型

#### 5.3.1 证型与脉象对应关系

| 证型 | 主脉 | 兼脉 | 临床表现 |
|------|------|------|----------|
| 表证 | 浮脉 | 浮紧(风寒)、浮数(风热) | 恶寒发热，头痛身痛 |
| 里实热证 | 洪脉 | 数脉、滑脉 | 高热口渴，便秘尿黄 |
| 里虚寒证 | 沉迟 | 细脉、弱脉 | 畏寒肢冷，腹痛喜温 |
| 气虚证 | 虚脉 | 细脉、弱脉 | 神疲乏力，少气懒言 |
| 血虚证 | 细脉 | 虚脉、涩脉 | 面色苍白，头晕眼花 |
| 阴虚证 | 细数 | 虚脉 | 五心烦热，盗汗颧红 |
| 阳虚证 | 沉细 | 迟脉、弱脉 | 畏寒肢冷，小便清长 |
| 气滞证 | 弦脉 | 涩脉 | 胸胁胀痛，情志不畅 |
| 血瘀证 | 涩脉 | 弦脉、结代 | 刺痛固定，舌质紫暗 |
| 痰湿证 | 滑脉 | 濡脉、缓脉 | 胸闷痰多，身体困重 |
| 肝郁气滞 | 弦脉 | 细脉 | 情志抑郁，胸胁胀痛 |
| 肝阳上亢 | 弦细数 | 洪脉 | 头痛眩晕，面红目赤 |
| 心火亢盛 | 数脉 | 洪脉 | 心烦失眠，口舌生疮 |
| 脾胃虚弱 | 缓弱 | 细脉 | 食少腹胀，大便溏薄 |
| 肾气不足 | 沉细 | 弱脉 | 腰膝酸软，耳鸣健忘 |

---

## 六、方剂推荐系统

### 6.1 方剂知识库

#### 6.1.1 数据库设计

```sql
-- 方剂表
CREATE TABLE prescriptions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,           -- 方剂名称
    pinyin VARCHAR(100),                   -- 拼音
    category VARCHAR(50),                  -- 分类 (解表剂/清热剂等)
    source TEXT,                           -- 来源典籍
    composition TEXT NOT NULL,             -- 组成 (JSON格式)
    dosage TEXT,                           -- 用法用量
    efficacy TEXT NOT NULL,                -- 功效
    indications TEXT NOT NULL,             -- 主治
    contraindications TEXT,                -- 禁忌
    modifications TEXT,                    -- 加减变化
    notes TEXT,                            -- 注意事项
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 药材表
CREATE TABLE herbs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,           -- 药材名称
    pinyin VARCHAR(100),
    nature VARCHAR(20),                    -- 性 (寒热温凉)
    flavor VARCHAR(50),                    -- 味 (辛甘酸苦咸)
    meridian VARCHAR(100),                 -- 归经
    efficacy TEXT,                         -- 功效
    dosage_range VARCHAR(50),              -- 用量范围
    contraindications TEXT,                -- 禁忌
    interactions TEXT                      -- 药物相互作用
);

-- 证型-方剂关联表
CREATE TABLE syndrome_prescription (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    syndrome_name VARCHAR(100) NOT NULL,   -- 证型名称
    syndrome_type VARCHAR(50),             -- 证型分类
    main_pulse VARCHAR(50),                -- 主脉
    secondary_pulse VARCHAR(50),           -- 兼脉
    prescription_id INTEGER,               -- 关联方剂ID
    match_score DECIMAL(3,2),              -- 匹配分数
    priority INTEGER DEFAULT 0,            -- 推荐优先级
    FOREIGN KEY (prescription_id) REFERENCES prescriptions(id)
);

-- 用户脉诊记录表
CREATE TABLE pulse_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id VARCHAR(50) NOT NULL,
    record_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    main_pulse VARCHAR(50),                -- 主脉
    secondary_pulse VARCHAR(50),           -- 兼脉
    pulse_rate INTEGER,                    -- 脉率
    pulse_features TEXT,                   -- 脉象特征 (JSON)
    syndrome VARCHAR(100),                 -- 辨证结果
    confidence DECIMAL(3,2),               -- 置信度
    recommended_prescription_id INTEGER,   -- 推荐方剂
    user_feedback TEXT,                    -- 用户反馈
    FOREIGN KEY (recommended_prescription_id) REFERENCES prescriptions(id)
);
```

#### 6.1.2 经典方剂示例

```json
{
  "prescriptions": [
    {
      "name": "柴胡疏肝散",
      "category": "理气剂",
      "source": "《景岳全书》",
      "composition": [
        {"herb": "柴胡", "dosage": "6g", "role": "君"},
        {"herb": "香附", "dosage": "9g", "role": "臣"},
        {"herb": "川芎", "dosage": "9g", "role": "臣"},
        {"herb": "陈皮", "dosage": "9g", "role": "佐"},
        {"herb": "枳壳", "dosage": "9g", "role": "佐"},
        {"herb": "白芍", "dosage": "9g", "role": "佐"},
        {"herb": "甘草", "dosage": "3g", "role": "使"}
      ],
      "efficacy": "疏肝理气，活血止痛",
      "indications": "肝气郁结证。胁肋疼痛，胸闷喜太息，情志抑郁易怒，或嗳气，脘腹胀满，脉弦",
      "contraindications": "孕妇慎用；肝阴不足者慎用",
      "syndrome_match": {
        "main_pulse": "弦脉",
        "secondary_pulse": ["细脉", "涩脉"],
        "syndrome": "肝郁气滞证",
        "match_score": 0.95
      }
    },
    {
      "name": "四君子汤",
      "category": "补益剂",
      "source": "《太平惠民和剂局方》",
      "composition": [
        {"herb": "人参", "dosage": "9g", "role": "君"},
        {"herb": "白术", "dosage": "9g", "role": "臣"},
        {"herb": "茯苓", "dosage": "9g", "role": "佐"},
        {"herb": "甘草", "dosage": "6g", "role": "使"}
      ],
      "efficacy": "益气健脾",
      "indications": "脾胃气虚证。面色萎白，语声低微，气短乏力，食少便溏，舌淡苔白，脉虚弱",
      "contraindications": "阴虚火旺者慎用",
      "syndrome_match": {
        "main_pulse": "虚脉",
        "secondary_pulse": ["细脉", "弱脉"],
        "syndrome": "脾胃气虚证",
        "match_score": 0.92
      }
    },
    {
      "name": "桂枝汤",
      "category": "解表剂",
      "source": "《伤寒论》",
      "composition": [
        {"herb": "桂枝", "dosage": "9g", "role": "君"},
        {"herb": "白芍", "dosage": "9g", "role": "臣"},
        {"herb": "生姜", "dosage": "9g", "role": "佐"},
        {"herb": "大枣", "dosage": "3枚", "role": "佐"},
        {"herb": "甘草", "dosage": "6g", "role": "使"}
      ],
      "efficacy": "解肌发表，调和营卫",
      "indications": "外感风寒表虚证。发热头痛，汗出恶风，鼻鸣干呕，苔白不渴，脉浮缓或浮弱",
      "contraindications": "外感风寒表实证禁用；温病初起禁用",
      "syndrome_match": {
        "main_pulse": "浮脉",
        "secondary_pulse": ["缓脉", "弱脉"],
        "syndrome": "风寒表虚证",
        "match_score": 0.94
      }
    }
  ]
}
```

### 6.2 方剂推荐算法

```python
class PrescriptionRecommender:
    """方剂推荐系统"""
    
    def __init__(self, db_connection):
        self.db = db_connection
        self.load_knowledge_base()
    
    def recommend(self, pulse_result, user_profile=None, top_k=3):
        """
        根据脉象结果推荐方剂
        
        Args:
            pulse_result: 脉象分析结果
            user_profile: 用户画像 (年龄、性别、体质等)
            top_k: 返回推荐数量
        
        Returns:
            list: 推荐方剂列表
        """
        # 1. 基于脉象匹配证型
        syndrome = self.match_syndrome(pulse_result)
        
        # 2. 根据证型查询候选方剂
        candidates = self.get_candidate_prescriptions(syndrome)
        
        # 3. 计算匹配分数
        scored_candidates = []
        for prescription in candidates:
            score = self.calculate_match_score(
                prescription, 
                pulse_result, 
                syndrome,
                user_profile
            )
            scored_candidates.append((prescription, score))
        
        # 4. 排序并返回Top-K
        scored_candidates.sort(key=lambda x: x[1], reverse=True)
        return scored_candidates[:top_k]
    
    def calculate_match_score(self, prescription, pulse_result, syndrome, user_profile):
        """计算方剂匹配分数"""
        score = 0.0
        
        # 脉象匹配度 (40%)
        pulse_match = self.calculate_pulse_match(
            prescription, 
            pulse_result
        )
        score += pulse_match * 0.4
        
        # 证型匹配度 (30%)
        syndrome_match = self.calculate_syndrome_match(
            prescription, 
            syndrome
        )
        score += syndrome_match * 0.3
        
        # 用户适配度 (20%)
        if user_profile:
            user_match = self.calculate_user_match(
                prescription, 
                user_profile
            )
            score += user_match * 0.2
        
        # 方剂权威性 (10%)
        authority_score = prescription.get('authority_score', 0.8)
        score += authority_score * 0.1
        
        return score
    
    def calculate_pulse_match(self, prescription, pulse_result):
        """计算脉象匹配度"""
        match_syndrome = prescription['syndrome_match']
        
        # 主脉匹配
        main_pulse_match = 1.0 if pulse_result['main_pulse'] == match_syndrome['main_pulse'] else 0.0
        
        # 兼脉匹配
        secondary_pulses = match_syndrome.get('secondary_pulse', [])
        secondary_match = 0.0
        if pulse_result['secondary_pulse'] in secondary_pulses:
            secondary_match = 1.0
        elif len(secondary_pulses) > 0:
            secondary_match = 0.5  # 部分匹配
        
        return (main_pulse_match * 0.7 + secondary_match * 0.3)
    
    def generate_prescription_report(self, recommendation):
        """生成方剂推荐报告"""
        report = {
            'pulse_analysis': {
                'main_pulse': recommendation['pulse_result']['main_pulse'],
                'secondary_pulse': recommendation['pulse_result']['secondary_pulse'],
                'syndrome': recommendation['syndrome'],
                'confidence': recommendation['confidence']
            },
            'recommended_prescription': {
                'name': recommendation['prescription']['name'],
                'composition': recommendation['prescription']['composition'],
                'dosage': recommendation['prescription']['dosage'],
                'efficacy': recommendation['prescription']['efficacy'],
                'indications': recommendation['prescription']['indications'],
                'contraindications': recommendation['prescription']['contraindications']
            },
            'alternative_prescriptions': [
                # 备选方剂
            ],
            'lifestyle_advice': self.generate_lifestyle_advice(recommendation['syndrome']),
            'dietary_suggestions': self.generate_dietary_suggestions(recommendation['syndrome']),
            'warning': '本推荐仅供参考，请在专业中医师指导下用药'
        }
        return report
```

---

## 七、数据同步与存储方案

### 7.1 数据同步架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据同步架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐                    ┌──────────────┐          │
│  │   手表端      │                    │   手机端      │          │
│  │  (华为GT4)   │◄───── BLE 5.0 ────►│  (Android)   │          │
│  │              │                    │              │          │
│  │ • 本地缓存    │                    │ • 数据接收    │          │
│  │ • 数据压缩    │                    │ • 数据解析    │          │
│  │ • 断点续传    │                    │ • 云端同步    │          │
│  └──────────────┘                    └──────────────┘          │
│                                               │                │
│                                               │ HTTPS/WiFi     │
│                                               ▼                │
│                                      ┌──────────────┐          │
│                                      │   云端服务器   │          │
│                                      │              │          │
│                                      │ • 数据存储    │          │
│                                      │ • AI推理     │          │
│                                      │ • 模型更新    │          │
│                                      └──────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 数据格式定义

#### 7.2.1 脉象数据包

```json
{
  "packet_type": "pulse_data",
  "version": "1.0",
  "timestamp": "2024-01-15T09:30:00Z",
  "device_info": {
    "device_id": "GT4_12345678",
    "model": "HUAWEI WATCH GT4",
    "os_version": "HarmonyOS 4.0",
    "app_version": "1.2.0"
  },
  "user_info": {
    "user_id": "user_12345",
    "age": 35,
    "gender": "male",
    "body_type": "normal"
  },
  "measurement": {
    "duration": 60,
    "sample_rate": 100,
    "signal_quality": 0.92,
    "ppg_data": "<base64_encoded_compressed_data>",
    "accelerometer_data": "<base64_encoded_compressed_data>"
  },
  "analysis_result": {
    "main_pulse": "弦脉",
    "secondary_pulse": "细脉",
    "pulse_rate": 72,
    "pulse_features": {
      "position": {"floating": 0.2, "normal": 0.6, "deep": 0.2},
      "rate": {"slow": 0.1, "normal": 0.85, "fast": 0.05},
      "force": {"weak": 0.3, "normal": 0.5, "strong": 0.2},
      "shape": {"thin": 0.6, "normal": 0.3, "full": 0.1},
      "tautness": 0.75,
      "smoothness": 0.65
    },
    "syndrome": "肝郁气滞证",
    "confidence": 0.87
  }
}
```

### 7.3 同步策略

| 场景 | 同步方式 | 触发条件 | 数据量 |
|------|----------|----------|--------|
| 实时同步 | BLE通知 | 脉诊完成 | ~10KB |
| 批量同步 | BLE传输 | 手表连接手机时 | ~100KB/天 |
| 历史同步 | WiFi/4G | 用户手动触发 | 取决于记录数 |
| 紧急同步 | BLE+云端 | 检测到异常脉象 | 立即 |

---

## 八、安全与隐私设计

### 8.1 数据安全

1. **传输加密**: 所有数据传输使用TLS 1.3加密
2. **存储加密**: 本地敏感数据使用AES-256加密
3. **身份认证**: 用户登录采用双因素认证
4. **访问控制**: 基于角色的权限管理

### 8.2 隐私保护

1. **数据最小化**: 仅收集必要的健康数据
2. **用户授权**: 明确的隐私政策和用户同意
3. **数据脱敏**: 云端存储的数据进行脱敏处理
4. **本地优先**: 优先在本地处理敏感数据

---

## 九、开发计划

### 9.1 开发阶段

| 阶段 | 周期 | 主要任务 | 交付物 |
|------|------|----------|--------|
| 第一阶段 | 4周 | 手表端基础功能 | PPG采集、信号处理、基础UI |
| 第二阶段 | 4周 | 脉象识别算法 | 特征提取、分类模型、本地推理 |
| 第三阶段 | 3周 | Android客户端 | UI开发、数据同步、报告展示 |
| 第四阶段 | 3周 | 方剂推荐系统 | 知识库、推荐算法、报告生成 |
| 第五阶段 | 2周 | 集成测试优化 | 系统测试、性能优化、Bug修复 |
| 第六阶段 | 2周 | 上线准备 | 文档完善、应用商店提交 |

### 9.2 技术风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| PPG信号质量不稳定 | 高 | 多传感器融合、运动检测、质量评估 |
| 脉象识别准确率低 | 高 | 大量临床数据训练、专家标注、模型优化 |
| 手表端算力不足 | 中 | 模型轻量化、云端协同推理 |
| 数据隐私合规 | 中 | 遵循GDPR、网络安全法、数据本地化 |

---

## 十、总结

本设计文档详细描述了基于华为WATCH GT4的中医脉象诊断软件系统的整体架构、功能模块、算法设计和实现方案。系统通过智能手表采集PPG信号，结合中医脉诊理论和人工智能技术，实现28种脉象的自动识别、辨证分析和方剂推荐，为中医数字化诊疗提供了一套完整的解决方案。

**核心创新点：**
1. 首创基于消费级智能手表的中医脉象诊断系统
2. 融合传统中医理论与现代信号处理技术
3. 端云协同的AI推理架构
4. 个性化的中医方剂推荐系统
5. 长期脉象健康趋势追踪

**预期效果：**
- 脉象识别准确率: ≥85%
- 单次数采时间: ≤60秒
- 报告生成时间: ≤3秒
- 用户满意度: ≥4.5/5.0

---

*文档版本: v1.0*  
*最后更新: 2024年1月*  
*作者: AI Assistant*
